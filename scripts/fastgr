#!/usr/bin/env mantidpythonnightly
from fastgr import Ui_MainWindow
from mantid.simpleapi import CloneWorkspace, CreateWorkspace, LoadAscii, \
    PDFFourierTransform, SavePDFGui
import numpy as np
import os
from PyQt4 import QtCore, QtGui, uic
import sys

# for PDFFourierTransform the options 'S(Q)', 'S(Q)-1', 'Q[S(Q)-1]'
SOFQ_TYPE_SQ = 'S(Q)'
SOFQ_TYPE_SQMINUSONE = 'S(Q)-1'
SOFQ_TYPE_QSQMINUSONE = 'Q[S(Q)-1]'

YLABEL_UNITS = {SOFQ_TYPE_SQ:'',
                SOFQ_TYPE_SQMINUSONE:'',
                SOFQ_TYPE_QSQMINUSONE:' ($\\AA^{-1}$)'}




class MyApp(QtGui.QMainWindow, Ui_MainWindow):
    GR = None
    SQ = None
    SQmodified = None

    def __init__(self):
        QtGui.QApplication.setStyle(QtGui.QStyleFactory.create("Cleanlooks"))
        QtGui.QMainWindow.__init__(self)
        Ui_MainWindow.__init__(self)
        self.setupUi(self)
        #btn commands
        self.btnGenerateGR.clicked.connect(self.calculateGR)
        self.btnLoadSQ.clicked.connect(self.read_SQ_file)
        self.comboRecipType.activated.connect(self.plot_SQ)
        self.btnSaveGR.clicked.connect(self.save_GR_file)
        self.btnGenerateGR.setEnabled(False)
        self.btnSaveGR.setEnabled(False)

        self.doubleSpinBoxDelR.setMinimum(0.01)
        self.doubleSpinBoxDelR.setMaximum(1.00)
        self.doubleSpinBoxDelR.setSingleStep(0.01)
        self.doubleSpinBoxDelR.setValue(0.01)

        self.loaded_once = False

        self.top_plot.set_xlabel('Q ($\\AA^{-1}$)')
        self.top_plot.canvas.ax.figure.tight_layout()
        self.bottom_plot.set_xlabel('r ($\\AA$)')
        self.top_plot.canvas.ax.figure.tight_layout()

    def set_Q_gui_elements(self):
        if self.SQ is None:
            return

        #configure Spin Boxes based on data (assume linearly spaced)
        qArray = self.SQ.readX(0)
        SqEArray = self.SQ.readE(0)
        filter = np.invert(np.isnan(SqEArray))
        orig_size = qArray.size
        qArray = qArray[filter]
        if orig_size != qArray.size:
            print 'WARNING: found NaN in uncertainties'
        qmin = np.min(qArray)
        qmax = np.max(qArray)
        qdel = (qmax-qmin)/float(qArray.size)

        self.doubleSpinBoxQmin.setMinimum(qmin)
        self.doubleSpinBoxQmin.setMaximum(qmax-qdel)
        self.doubleSpinBoxQmin.setSingleStep(qdel)
        self.doubleSpinBoxQmin.setValue(qmin)

        self.doubleSpinBoxQmax.setMinimum(qmin+qdel)
        self.doubleSpinBoxQmax.setMaximum(qmax)
        self.doubleSpinBoxQmax.setSingleStep(qdel)
        self.doubleSpinBoxQmax.setValue(qmax)

    def read_SQ_file_custom(self, filename):
        qArray = []
        SqArray = []

        with open(filename, 'r') as myfile:
            data = myfile.readlines()

        #determine length of junk at start of file
        for i in range(len(data)):
            if(len(data[i].strip()) > 0): #check that not a blank line
                is_good = True
                for k in range(i,i+10):
                    if (len(data[k].strip())) > 0: #now check if THIS line isn't blank
                        try:
                            float(data[k].split()[0])
                            yes_this = True
                        except ValueError:
                            yes_this = False

                        if yes_this:
                            pass #s'all good
                        else:
                            is_good = False
                            break
                    else:
                        is_good = False
                        break
            if is_good:
                start = i
                break

        # read in the data
        for i in range(0,len(data)-start):
            qArray.append(float(data[i+start].split()[0]))
            SqArray.append(float(data[i+start].split()[1]))

        # for PDFFourierTransform the options 'S(Q)', 'S(Q)-1', 'Q[S(Q)-1]'
        self.SQ = CreateWorkspace(OutputWorkspace='SQ',
                                  UnitX='MomentumTransfer',
                                  YUnitLabel=SOFQ_TYPE_SQ,
                                  DataX=qArray, DataY=SqArray)
        self.SQ += 1.

    def read_SQ_file(self):
        # clear out the current plots
        self.top_plot.canvas.ax.clear()
        self.top_plot.canvas.ax.figure.tight_layout()
        self.bottom_plot.canvas.ax.clear()
        self.bottom_plot.canvas.ax.figure.tight_layout()

        self.SQmodified = None

        filename = QtGui.QFileDialog.getOpenFileName(self,
                                                     'Opener File Thinger')
        if not os.path.exists(filename):
            raise RuntimeError("Cannot open non-existent file '%s'" % filename)
        filename = str(filename)
        print "opening file: '%s'" % filename

        type = 'IDL'  # TODO should get from customization of file dialog

        if type == 'IDL':
            self.SQ = LoadAscii(Filename=filename,
                                OutputWorkspace='SQ',
                                Unit='MomentumTransfer')
            self.SQ += 1.  # IDL produces S(Q)-1
            self.SQ.setYUnitLabel(SOFQ_TYPE_SQ)
        elif type == 'PDFgetN':
            self.SQ = LoadPDFgetN(Filename=filename,
                                  OutputWorkspace='SQ')
        else:  # default back to flexible parser
            self.read_SQ_file_custom(filename)

        self.set_Q_gui_elements()
        self.plot_SQ()

        self.btnGenerateGR.setEnabled(True)

        self.calculateGR()

    def save_GR_file(self):
        #name = QtGui.QFileDialog.getSaveFileName(self, 'Makey-Saves')
        maybe_name = "myGR_Qmin"+str(self.doubleSpinBoxQmin.value())+"_Qmax"+str(self.doubleSpinBoxQmax.value())+".gr"
        name = QtGui.QFileDialog.getSaveFileName(self, ('Makey-Saves'),maybe_name)
        if len(name) > 0:  # verify a name was specified
            SavePDFGui(InputWorkspace=self.GR, Filename=str(name))

    def modifySQ(self):
        self.SQmodified = CloneWorkspace(InputWorkspace=self.SQ,
                                         OutputWorkspace='SQmodified')

        qArray = self.SQmodified.readX(0)
        SqArray = self.SQmodified.readY(0)
        SqEArray = self.SQmodified.readE(0)

        # TODO all the funny things that you want to do

        self.SQmodified.setX(0, qArray)
        self.SQmodified.setY(0, SqArray)
        self.SQmodified.setE(0, SqEArray)

        self.plot_SQ()
        self.calculateGR()


    def calculateGR(self):
        rmax   = float(self.doubleSpinBoxRmax.value())
        rmin   = float(self.doubleSpinBoxRmin.value())
        rdelta = float(self.doubleSpinBoxDelR.value())
        if rmin >= rmax:
            raise RuntimeError("Rmin must be less than Rmax (%f >= %f)"
                               % (rmin, rmax))
        if rdelta >= (rmax-rmin):
            raise RuntimeError("Must have more than one bin in G(r) (%f >= %f)"
                               % (rdelta, (rmax-rmin)))

        qmin = float(self.doubleSpinBoxQmin.value())
        qmax = float(self.doubleSpinBoxQmax.value())
        if qmin >= qmax:
            raise RuntimeError("Qmin must be less than Qmax (%f >= %f)"
                               % (qmin, qmax))

        kwargs = {'OutputWorkspace':'Gr',
                  'Qmin':qmin,
                  'Qmax':qmax,
                  'PDFType':'G(r)',
                  'DeltaR':rdelta,
                  'Rmax':rmax}

        if self.SQmodified is None:
            inputsofqtype = self.SQ.YUnitLabel()
            self.GR = PDFFourierTransform(InputWorkspace=self.SQ,
                                          InputSofQType=inputsofqtype,
                                          **kwargs)
        else:
            inputsofqtype = self.SQmodified.YUnitLabel()
            self.GR = PDFFourierTransform(InputWorkspace=self.SQmodified,
                                          InputSofQType=inputsofqtype,
                                          **kwargs)

        #self.GR *= (np.pi / 2.)  # wonky factor should not be here

        self.btnSaveGR.setEnabled(True)

        self.plot_GR()

    def plot_SQ_asymptotic(self, inputsofqtype):
        qArray = self.SQ.readX(0)
        qArrayLow  = [qArray[0], qArray[int(qArray.size/4.)]]
        qArrayHigh = [qArray[int(-1*(qArray.size/4))], qArray[-1]]

        if inputsofqtype == SOFQ_TYPE_SQ:
            yArrayHigh = [1., 1.]
        elif inputsofqtype == SOFQ_TYPE_SQMINUSONE:
            yArrayHigh = [0., 0.]
        elif inputsofqtype == SOFQ_TYPE_QSQMINUSONE:
            yArrayHigh = [0., 0.]

        self.top_plot.canvas.ax.plot(qArrayHigh, yArrayHigh,
                                     color='k', linestyle='--')


    def plot_GR_asymptotic(self):
        rArray = self.GR.readX(0)
        rArrayLow  = [rArray[0], rArray[int(rArray.size/4.)]]
        rArrayHigh = [rArray[int(-1*(rArray.size/4))], rArray[-1]]

        self.bottom_plot.canvas.ax.plot(rArrayHigh, [0., 0.],
                                        color='k', linestyle='--')


    def plot_SQ(self):
        self.top_plot.canvas.ax.clear()
        if self.SQ is None:
            return

        sofqtype = str(self.comboRecipType.currentText())
        sofqtype = sofqtype.strip().split()[-1].strip()

        if sofqtype == SOFQ_TYPE_SQ:
            self.top_plot.canvas.ax.plot(self.SQ.readX(0), self.SQ.readY(0))
            if self.SQmodified is not None:
                self.top_plot.canvas.ax.plot(self.SQmodified.readX(0),
                                             self.SQmodified.readY(0))
        elif sofqtype == SOFQ_TYPE_SQMINUSONE:
            sqm1 = np.copy(self.SQ.readY(0)) - 1.
            self.top_plot.canvas.ax.plot(self.SQ.readX(0), sqm1)
            if self.SQmodified is not None:
                sqm1modified = np.copy(self.SQ.readY(0)) - 1.
                self.top_plot.canvas.ax.plot(self.SQmodified.readX(0),
                                             sqm1modified)
        elif sofqtype == SOFQ_TYPE_QSQMINUSONE:
            qsqm1 = (np.copy(self.SQ.readY(0)) - 1.) * self.SQ.readX(0)
            self.top_plot.canvas.ax.plot(self.SQ.readX(0), qsqm1)
            if self.SQmodified is not None:
                qsqm1modified = (np.copy(self.SQmodified.readY(0)) - 1.) \
                              * self.SQmodified.readX(0)
                self.top_plot.canvas.ax.plot(self.SQmodified.readX(0),
                                             qsqm1modified)

        self.plot_SQ_asymptotic(sofqtype)

        self.top_plot.set_xlabel('Q ($\\AA^{-1}$)')
        self.top_plot.canvas.ax.set_xbound(self.SQ.readX(0)[0],
                                           self.SQ.readX(0)[-1])
        self.top_plot.set_ylabel(sofqtype + YLABEL_UNITS[sofqtype])
        self.top_plot.canvas.ax.figure.tight_layout()
        self.top_plot.canvas.draw()

    def plot_GR(self):
        self.bottom_plot.canvas.ax.clear()

        self.bottom_plot.canvas.ax.plot(self.GR.readX(0), self.GR.readY(0))
        self.plot_GR_asymptotic()

        self.bottom_plot.set_xlabel('r ($\\AA$)')
        self.bottom_plot.canvas.ax.set_xbound(self.GR.readX(0)[0],
                                              self.GR.readX(0)[-1])
        self.bottom_plot.set_ylabel('G(r) ($\\AA^{-2}$)')
        self.bottom_plot.canvas.ax.figure.tight_layout()
        self.bottom_plot.canvas.draw()

if __name__ == "__main__":
    app = QtGui.QApplication(sys.argv)
    window = MyApp()
    window.show()
    sys.exit(app.exec_())
